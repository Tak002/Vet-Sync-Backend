<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>환자 상태관리표</title>
    <style>
        :root{
            --bg:#0b1220;
            --panel:#0f1b33;
            --panel2:#0c172c;
            --text:#e8eefc;
            --muted:#a9b6d6;
            --line:#223258;

            --empty:#0e1a30;
            --pending:#3a2a00;
            --inprogress:#0b2c3a;
            --confirm:#2a0b3a;
            --completed:#0a3a17;

            --shadow: 0 10px 25px rgba(0,0,0,.35);
            --radius: 14px;

            /* sticky column widths */
            --col1: 160px;   /* Definition */
            --col2: 260px;   /* Definition Note */
            --col3: 90px;    /* 처치시간 */
            --col2-left: var(--col1);
            --col3-left: calc(var(--col1) + var(--col2));
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", sans-serif;
            color:var(--text);
            background: radial-gradient(1200px 800px at 30% 10%, #13244a 0%, rgba(19,36,74,0) 60%),
            radial-gradient(1200px 800px at 90% 40%, #1a2a54 0%, rgba(26,42,84,0) 60%),
            var(--bg);
        }
        .app{max-width:1600px;margin:0 auto;padding:18px;display:flex;flex-direction:column;gap:14px}
        .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:14px}
        .card{
            background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
            border: 1px solid rgba(255,255,255,.08);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        .patient{flex:1;padding:14px 14px 10px;display:flex;flex-direction:column;gap:10px}
        .patient h1{margin:0;font-size:18px;letter-spacing:.2px}
        .meta{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
        .kv{
            background: rgba(0,0,0,.15);
            border:1px solid rgba(255,255,255,.08);
            border-radius: 12px;
            padding:10px;
            min-height:54px;
        }
        .kv .k{font-size:12px;color:var(--muted);margin-bottom:4px}
        .kv .v{font-size:13px;word-break:break-all}

        .actions{width:320px;padding:14px;display:flex;flex-direction:column;gap:10px}
        .actions h2{margin:0;font-size:14px;color:var(--muted);font-weight:600}
        .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        input[type="text"], input[type="date"], input[type="password"]{
            width:100%;
            background: rgba(0,0,0,.22);
            border:1px solid rgba(255,255,255,.10);
            color: var(--text);
            padding:10px 11px;
            border-radius: 10px;
            outline:none;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="password"]:focus{
            border-color: rgba(160,200,255,.45);
            box-shadow: 0 0 0 3px rgba(80,140,255,.18);
        }
        button{
            cursor:pointer;
            background: rgba(90,150,255,.18);
            border:1px solid rgba(90,150,255,.35);
            color: var(--text);
            padding:10px 11px;
            border-radius: 10px;
            font-weight:600;
            transition:.15s ease;
        }
        button:hover{ transform: translateY(-1px); background: rgba(90,150,255,.25); }
        button:active{ transform: translateY(0px); }
        button:disabled{ opacity:.5; cursor:not-allowed; transform:none; }
        .btn-ghost{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10); }
        .btn-success{ background: rgba(70,220,140,.14); border-color: rgba(70,220,140,.30); }

        .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
        .pill{
            display:inline-flex;align-items:center;gap:8px;padding:6px 10px;
            background: rgba(255,255,255,.06);
            border:1px solid rgba(255,255,255,.08);
            border-radius: 999px;font-size:12px;color: var(--muted);
        }
        .dot{width:10px;height:10px;border-radius:50%;background: var(--empty);border:1px solid rgba(255,255,255,.10)}
        .dot.pending{ background: var(--pending); }
        .dot.inprogress{ background: var(--inprogress); }
        .dot.confirm{ background: var(--confirm); }
        .dot.completed{ background: var(--completed); }

        .table-wrap{padding:12px;overflow:auto;border-radius: var(--radius)}
        table{border-collapse:separate;border-spacing:0;min-width:1560px;width:100%;color:var(--text);font-size:12px}
        thead th{
            position: sticky; top:0; z-index:6;
            background: rgba(12,23,44,.95);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid rgba(255,255,255,.10);
        }
        th, td{
            border-right:1px solid rgba(255,255,255,.06);
            border-bottom:1px solid rgba(255,255,255,.06);
            padding:8px 8px;text-align:center;vertical-align:middle;white-space:nowrap
        }

        /* Sticky columns: 1) Definition 2) Definition Note 3) 처치시간 */
        th:first-child, td:first-child{
            position: sticky; left:0; z-index:5;
            background: rgba(12,23,44,.95);
            backdrop-filter: blur(6px);
            text-align:left;
            min-width:var(--col1); max-width:var(--col1);
        }
        th:nth-child(2), td:nth-child(2){
            position: sticky; left:var(--col2-left); z-index:5;
            background: rgba(12,23,44,.95);
            backdrop-filter: blur(6px);
            text-align:left;
            min-width:var(--col2); max-width:var(--col2);
        }
        th:nth-child(3), td:nth-child(3){
            position: sticky; left:var(--col3-left); z-index:5;
            background: rgba(12,23,44,.95);
            backdrop-filter: blur(6px);
            min-width:var(--col3); max-width:var(--col3);
        }

        td.cell{
            cursor:pointer;
            background: rgba(0,0,0,.12);
            transition:.12s ease;
            min-width:52px; max-width:86px; overflow:hidden; text-overflow:ellipsis;
        }
        td.cell:hover{
            outline:2px solid rgba(140,190,255,.45);
            outline-offset:-2px;
            filter: brightness(1.07);
        }
        td.cell.empty{ background: rgba(0,0,0,.10); color: rgba(232,238,252,.35); }
        td.cell.pending{ background: color-mix(in oklab, var(--pending) 82%, black 18%); }
        td.cell.inprogress{ background: color-mix(in oklab, var(--inprogress) 82%, black 18%); }
        td.cell.confirm{ background: color-mix(in oklab, var(--confirm) 82%, black 18%); }
        td.cell.completed{ background: color-mix(in oklab, var(--completed) 82%, black 18%); }
        td.cell .result{
            display:block;font-size:11px;line-height:1.2;max-height:2.4em;
            overflow:hidden;text-overflow:ellipsis;padding:0 2px
        }
        td.cell .sub{display:block;margin-top:3px;font-size:10px;color: rgba(232,238,252,.70);}

        .row-title{display:flex;flex-direction:column;gap:2px;padding:0 2px}
        .row-title .name{font-weight:700}
        .row-title .desc{font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis}

        /* Definition-note cell */
        td.note-cell{
            cursor:pointer;
            background: rgba(0,0,0,.10);
            transition:.12s ease;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
        }
        td.note-cell:hover{
            outline:2px solid rgba(140,190,255,.45);
            outline-offset:-2px;
            filter: brightness(1.07);
        }
        td.note-cell .note-text{
            display:block;
            max-width: calc(var(--col2) - 16px);
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
            font-size:11px;
            color: rgba(232,238,252,.92);
        }
        td.note-cell .note-sub{
            display:block;
            margin-top:3px;
            font-size:10px;
            color: rgba(232,238,252,.65);
        }

        .toast{
            position: fixed; left:50%; bottom:18px; transform: translateX(-50%);
            background: rgba(0,0,0,.55);
            border:1px solid rgba(255,255,255,.10);
            padding:10px 12px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            color: var(--text);
            font-size:13px;
            display:none;
            z-index:9999;
            max-width:90vw;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }

        /* Modal */
        .overlay{position:fixed;inset:0;background: rgba(0,0,0,.55);display:none;z-index:10000;padding:18px}
        .modal{
            max-width: 980px;
            margin:0 auto;
            margin-top:40px;
            background: rgba(15,27,51,.95);
            border:1px solid rgba(255,255,255,.10);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow:hidden;
        }
        .modal header{
            display:flex;justify-content:space-between;align-items:center;
            padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);gap:10px
        }
        .modal header h3{margin:0;font-size:14px;color:var(--text)}
        .modal header .close{background: rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);padding:8px 10px;border-radius: 10px}
        .modal .body{padding:14px;display:flex;gap:12px;flex-direction:column}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .help{font-size:12px;color:var(--muted);line-height:1.45}
        textarea, select{
            width:100%;
            background: rgba(0,0,0,.22);
            border:1px solid rgba(255,255,255,.10);
            color: var(--text);
            padding:10px 11px;
            border-radius: 10px;
            outline:none;
            resize: vertical;
            min-height: 110px;
        }
        select{ min-height: unset; height: 40px; }
        textarea{ min-height: 90px; }
        .modal footer{
            padding:12px 14px;border-top:1px solid rgba(255,255,255,.08);
            display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;align-items:center
        }
        .muted{color: var(--muted);font-size:12px}
        .chip{
            display:inline-flex;align-items:center;gap:8px;padding:6px 10px;
            background: rgba(255,255,255,.06);
            border:1px solid rgba(255,255,255,.08);
            border-radius: 999px;
            font-size:12px;
            color: var(--muted);
        }
        .field .muted{margin:0 0 6px}

        @media (max-width: 980px){
            .topbar{flex-direction:column;}
            .actions{width:100%;}
            .meta{grid-template-columns: repeat(2, minmax(0,1fr));}
            .two-col{ grid-template-columns: 1fr; }

            :root{
                --col1: 160px;
                --col2: 220px;
                --col3: 90px;
            }
        }
    </style>
</head>

<body>
<div class="app">
    <div class="topbar">
        <div class="card patient">
            <h1 id="patientTitle">환자 정보</h1>
            <div class="meta" id="patientMeta"></div>
        </div>

        <div class="card actions">
            <h2>페이지 설정</h2>

            <div class="row">
                <div style="flex:1">
                    <div class="muted" style="margin:0 0 6px">JWT Token</div>
                    <input id="jwtInput" type="password" placeholder="토큰만 붙여넣기 (Bearer 자동)" />
                </div>
            </div>

            <div class="row">
                <div style="flex:1">
                    <div class="muted" style="margin:0 0 6px">환자 ID</div>
                    <input id="patientIdInput" type="text" placeholder="e2da4625-7158-496f-9f84-9d26b7086ef2" />
                </div>
            </div>

            <div class="row">
                <div style="flex:1">
                    <div class="muted" style="margin:0 0 6px">날짜</div>
                    <input id="dateInput" type="date" />
                </div>
            </div>

            <div class="row">
                <button id="btnLoad">불러오기</button>
                <button id="btnReload" class="btn-ghost">새로고침</button>
            </div>

            <div class="muted">
                경로: <code>/tasks/patients/{patientId}/{taskDate}</code>
            </div>

            <div class="legend">
                <span class="pill"><span class="dot"></span>없음</span>
                <span class="pill"><span class="dot pending"></span>PENDING</span>
                <span class="pill"><span class="dot inprogress"></span>IN_PROGRESS</span>
                <span class="pill"><span class="dot confirm"></span>CONFIRM_WAITING</span>
                <span class="pill"><span class="dot completed"></span>COMPLETED</span>
            </div>

            <div class="help">
                • Task 셀 클릭 → Task 생성/상세<br/>
                • 공용 노트 셀 클릭 → 공용 노트 생성/수정<br/>
                • PATCH 규칙: <b>null=변경없음</b>, <b>""=값 비우기(미지정/삭제)</b><br/>
            </div>
        </div>
    </div>

    <div class="card table-wrap">
        <table id="chartTable" aria-label="환자 상태관리표"></table>
    </div>
</div>

<div class="toast" id="toast"></div>

<!-- Modal -->
<div class="overlay" id="overlay">
    <div class="modal">
        <header>
            <h3 id="modalTitle">상세</h3>
            <button class="close" id="modalClose">닫기</button>
        </header>
        <div class="body" id="modalBody"></div>
        <footer id="modalFooter"></footer>
    </div>
</div>

<script>
    /***********************
     * CONFIG
     ***********************/
    const API_BASE = "";
    const HOURS = Array.from({length: 24}, (_, i) => i);
    const hourLabel = (h) => String(h % 12 === 0 ? 12 : (h % 12));
    const hourPeriod = (h) => (h < 12 ? "AM" : "PM");
    const STATUS_LIST = ["PENDING","IN_PROGRESS","CONFIRM_WAITING","COMPLETED"];

    /***********************
     * STATE
     ***********************/
    const state = {
        jwtToken: "",
        patientId: null,
        date: null,
        patient: null,

        defs: [],
        defById: new Map(),
        fixedDefs: [],
        notFixedDefs: [],

        staffs: [],
        staffById: new Map(),

        rows: [],
        taskMap: new Map(),
        tasks: [],

        definitionNotes: [],
        noteByDefId: new Map(),   // key: taskDefinitionId -> note DTO
    };

    /***********************
     * HELPERS
     ***********************/
    const $ = (sel) => document.querySelector(sel);
    const escapeHtml = (s) => (s ?? "").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");

    function toast(msg){
        const t = $("#toast");
        t.textContent = msg;
        t.style.display = "block";
        clearTimeout(toast._timer);
        toast._timer = setTimeout(()=> t.style.display="none", 2200);
    }

    function getPathParamsFromUrl(){
        const parts = location.pathname.split("/").filter(Boolean);
        const idx = parts.indexOf("patients");
        if(idx !== -1 && parts[idx+2] === "management-charts"){
            return { pid: parts[idx+1], date: parts[idx+3] };
        }
        return { pid: null, date: null };
    }

    function statusToClass(status){
        if(!status) return "empty";
        switch(status){
            case "PENDING": return "pending";
            case "IN_PROGRESS": return "inprogress";
            case "CONFIRM_WAITING": return "confirm";
            case "COMPLETED": return "completed";
            default: return "empty";
        }
    }

    function readJwtFromInputAndPersist(){
        const jwt = ($("#jwtInput").value ?? "").trim();
        state.jwtToken = jwt;
        localStorage.setItem("jwtToken", jwt);
    }

    async function apiFetch(path, opts={}){
        const headers = opts.headers ? {...opts.headers} : {};
        headers["Content-Type"] = headers["Content-Type"] ?? "application/json";

        const token = (state.jwtToken ?? "").trim();
        if(token){
            headers["Authorization"] = token.startsWith("Bearer ") ? token : `Bearer ${token}`;
        }

        const res = await fetch(API_BASE + path, {...opts, headers});
        if(!res.ok){
            let body = "";
            try { body = await res.text(); } catch {}
            if(res.status === 401){
                throw new Error(`HTTP 401 Unauthorized - JWT 토큰을 확인해줘. ${body}`.trim());
            }
            throw new Error(`HTTP ${res.status} ${res.statusText} - ${body}`);
        }
        const text = await res.text();
        return text ? JSON.parse(text) : null;
    }

    function staffLabelById(id){
        if(!id) return "(미지정)";
        const s = state.staffById.get(id);
        if(!s) return id;
        return `${s.name} (${s.role}${s.isActive ? "" : " · 비활성"})`;
    }

    function renderStaffSelect(selectId, selectedStaffId){
        const list = (state.staffs ?? []).slice()
            .sort((a,b)=> (b.isActive - a.isActive) || (a.name ?? "").localeCompare(b.name ?? ""));

        const options = [
            `<option value="">(미지정으로 저장)</option>`,
            ...list.map(s => {
                const selected = (s.id === selectedStaffId) ? "selected" : "";
                const inactive = s.isActive ? "" : " [비활성]";
                return `<option value="${escapeHtml(s.id)}" ${selected}>${escapeHtml(s.name)} · ${escapeHtml(s.role)}${inactive}</option>`;
            })
        ].join("");

        return `<select id="${escapeHtml(selectId)}">${options}</select>`;
    }

    function renderStatusSelect(selectId, selectedStatus){
        return `<select id="${escapeHtml(selectId)}">${
            STATUS_LIST.map(st => `<option value="${escapeHtml(st)}" ${st===selectedStatus?"selected":""}>${escapeHtml(st)}</option>`).join("")
        }</select>`;
    }

    /**
     * PATCH payload 규칙:
     * - null  : 변경 없음(필드 미포함으로 보냄)
     * - ""    : 비우기(미지정/삭제)
     * - "..." : 값 설정
     */
    function buildPatchPayloadWithEmptyAllowed(originalTask, cur){
        const payload = {};

        const origAssignee = (originalTask.assigneeId ?? "");
        const curAssignee = (cur.assigneeId ?? "");
        if(curAssignee !== origAssignee){
            payload.assigneeId = curAssignee; // "" 가능
        }

        const origNotes = (originalTask.taskNotes ?? "");
        const curNotes = (cur.taskNotes ?? "");
        if(curNotes !== origNotes){
            payload.taskNotes = curNotes; // "" 가능
        }

        const origResult = (originalTask.result ?? "");
        const curResult = (cur.result ?? "");
        if(curResult !== origResult){
            payload.result = curResult; // "" 가능
        }

        return payload;
    }

    /***********************
     * API
     ***********************/
    const API = {
        getPatient: (patientId) => apiFetch(`/patients/${patientId}`, { method:"GET" }),
        getTaskDefinitions: () => apiFetch(`/task-definitions`, { method:"GET" }),
        getPatientDayTasks: (patientId, taskDate) => apiFetch(`/tasks/patients/${patientId}/${taskDate}`, { method:"GET" }),
        createTask: (payload) => apiFetch(`/tasks`, { method:"POST", body: JSON.stringify(payload) }),

        getStaffs: () => apiFetch(`/staffs`, { method:"GET" }),

        patchTask: (taskId, payload) => apiFetch(`/tasks/${taskId}`, { method:"PATCH", body: JSON.stringify(payload) }),
        patchTaskStatus: (taskId, status) => apiFetch(`/tasks/${taskId}/status`, { method:"PATCH", body: JSON.stringify({ status }) }),

        // ✅ NEW: definition-notes
        getDefinitionNotes: (patientId, taskDate) => apiFetch(`/tasks/patients/${patientId}/${taskDate}/definition-notes`, { method:"GET" }),
        createDefinitionNote: (patientId, taskDate, payload) => apiFetch(`/tasks/patients/${patientId}/${taskDate}/definition-notes`, { method:"POST", body: JSON.stringify(payload) }),
        patchDefinitionNote: (patientId, taskDate, noteId, payload) => apiFetch(`/tasks/patients/${patientId}/${taskDate}/definition-notes/${noteId}`, { method:"PATCH", body: JSON.stringify(payload) }),
    };

    /***********************
     * RENDER: PATIENT CARD
     ***********************/
    function renderPatient(){
        const p = state.patient;
        if(!p){
            $("#patientTitle").textContent = "환자 정보";
            $("#patientMeta").innerHTML = "";
            return;
        }
        $("#patientTitle").textContent = `환자: ${p.name} (${p.species}${p.speciesDetail ? ` / ${p.speciesDetail}` : ""})`;
        const items = [
            ["환자 ID", p.id],
            ["병원 ID", p.hospitalId],
            ["보호자 ID", p.ownerId],
            ["상태", p.status],
            ["성별", p.gender],
            ["품종", p.breed ?? "-"],
            ["생성자", p.createdBy],
            ["조회 날짜", state.date],
        ];
        $("#patientMeta").innerHTML = items.map(([k,v]) => `
      <div class="kv">
        <div class="k">${escapeHtml(k)}</div>
        <div class="v">${escapeHtml(v ?? "-")}</div>
      </div>
    `).join("");
    }

    /***********************
     * BUILD ROWS / MAPS
     ***********************/
    function buildRows(){
        const fixedRows = state.fixedDefs
            .slice()
            .sort((a,b)=> (a.name ?? "").localeCompare(b.name ?? ""))
            .map(def => ({ type:"DEF", defId:def.id, label:def.name, desc:def.description ?? "" }));

        const usedNotFixedDefIds = new Set();
        for(const t of state.tasks){
            const def = state.defById.get(t.taskDefinitionId);
            if(def && !def.fixed) usedNotFixedDefIds.add(def.id);
        }

        const notFixedRows = Array.from(usedNotFixedDefIds)
            .map(id => state.defById.get(id))
            .filter(Boolean)
            .sort((a,b)=> (a.name ?? "").localeCompare(b.name ?? ""))
            .map(def => ({ type:"DEF", defId:def.id, label:def.name, desc:def.description ?? "" }));

        const blankRows = Array.from({length:4}, (_,i)=>({ type:"BLANK", blankIndex:i+1, label:"(공백)", desc:"클릭해서 항목 추가" }));

        state.rows = [...fixedRows, ...notFixedRows, ...blankRows];
    }

    function buildTaskMap(){
        state.taskMap.clear();
        for(const t of state.tasks){
            state.taskMap.set(`${t.taskDefinitionId}|${t.taskHour}`, t);
        }
    }

    function buildNoteMap(){
        state.noteByDefId = new Map();
        for(const n of (state.definitionNotes ?? [])){
            // 서버 응답 필드명은 너가 쓰는 DTO 기준:
            // { id, patientId, taskDefinitionId, taskDate, note, ... } 라고 가정
            // (필드가 다르면 아래 mapping만 바꾸면 됨)
            state.noteByDefId.set(n.taskDefinitionId, n);
        }
    }

    /***********************
     * RENDER TABLE
     ***********************/
    function renderTable(){
        const table = $("#chartTable");
        if(!state.date){ table.innerHTML = ""; return; }

        const thead = `
      <thead>
        <tr>
          <th>Date</th>
          <th>공용노트</th>
          <th>처치시간</th>
          <th colspan="12">AM</th>
          <th colspan="12">PM</th>
          <th>Info</th>
        </tr>
        <tr>
          <th></th>
          <th></th>
          <th>12</th>
          ${HOURS.slice(1,12).map(h=>`<th>${hourLabel(h)}</th>`).join("")}
          <th>12</th>
          ${HOURS.slice(13,24).map(h=>`<th>${hourLabel(h)}</th>`).join("")}
          <th></th>
        </tr>
      </thead>
    `;

        const rowsHtml = state.rows.map((r, rowIdx)=>{
            const left = r.type==="DEF"
                ? (() => {
                    const def = state.defById.get(r.defId);
                    const name = def?.name ?? r.label;
                    const desc = def?.description ?? r.desc ?? "";
                    return `
              <td>
                <div class="row-title">
                  <div class="name">${escapeHtml(name)}</div>
                  <div class="desc" title="${escapeHtml(desc)}">${escapeHtml(desc)}</div>
                </div>
              </td>
            `;
                })()
                : `
            <td>
              <div class="row-title">
                <div class="name">(공백)</div>
                <div class="desc">${escapeHtml(r.desc)}</div>
              </div>
            </td>
          `;

            // ✅ 공용 노트 컬럼
            const noteCell = (() => {
                if(r.type !== "DEF"){
                    return `<td class="note-cell muted" title="공백 행은 공용노트를 가질 수 없습니다.">-</td>`;
                }
                const note = state.noteByDefId.get(r.defId) ?? null;
                const noteText = note?.content ?? ""; // 서버 필드가 content면 여기 바꿔줘
                const noteId = note?.id ?? "";
                const sub = note ? `id: ${noteId}` : "클릭해서 작성";
                return `
          <td class="note-cell"
              data-cell-kind="NOTE"
              data-def-id="${escapeHtml(r.defId)}"
              data-note-id="${escapeHtml(noteId)}">
            <span class="note-text" title="${escapeHtml(noteText)}">${escapeHtml(noteText || "—")}</span>
            <span class="note-sub">${escapeHtml(sub)}</span>
          </td>
        `;
            })();

            const timeCol = `<td>-</td>`;

            const hourCells = HOURS.map(h=>{
                let task = null;
                if(r.type==="DEF") task = state.taskMap.get(`${r.defId}|${h}`) ?? null;

                const cls = task ? statusToClass(task.status) : "empty";
                const labelTop = task?.result ? escapeHtml(task.result) : "—";
                const small = task
                    ? `<span class="sub">${escapeHtml(task.status)}</span>`
                    : `<span class="sub">${hourPeriod(h)} ${hourLabel(h)}</span>`;

                return `
          <td class="cell ${cls}"
              data-cell-kind="TASK"
              data-row-type="${r.type}"
              data-def-id="${r.type==="DEF" ? r.defId : ""}"
              data-blank-index="${r.type==="BLANK" ? r.blankIndex : ""}"
              data-hour="${h}">
            <span class="result">${labelTop}</span>
            ${small}
          </td>
        `;
            }).join("");

            const right = (() => {
                if(r.type==="DEF"){
                    const def = state.defById.get(r.defId);
                    const fx = def?.fixed ? "FIXED" : "OPTIONAL";
                    return `<td title="${escapeHtml(def?.description ?? "")}">${escapeHtml(fx)}</td>`;
                }
                return `<td class="muted">빈 행(클릭→항목 선택)</td>`;
            })();

            return `<tr data-row-index="${rowIdx}">${left}${noteCell}${timeCol}${hourCells}${right}</tr>`;
        }).join("");

        table.innerHTML = thead + `<tbody>${rowsHtml}</tbody>`;
    }

    /***********************
     * MODALS
     ***********************/
    function openModal(title, bodyHtml, footerHtml){
        $("#modalTitle").textContent = title;
        $("#modalBody").innerHTML = bodyHtml;
        $("#modalFooter").innerHTML = footerHtml ?? "";
        $("#overlay").style.display = "block";
    }
    function closeModal(){ $("#overlay").style.display = "none"; }
    $("#modalClose").addEventListener("click", closeModal);
    $("#overlay").addEventListener("click", (e)=>{ if(e.target === $("#overlay")) closeModal(); });

    function openDefinitionNoteModal(defId){
        const def = state.defById.get(defId);
        const existing = state.noteByDefId.get(defId) ?? null;

        const body = `
      <div class="help">
        <b>${escapeHtml(def?.name ?? defId)}</b> · ${escapeHtml(state.date)} 공용 노트
        <div class="muted" style="margin-top:6px">
          ${existing ? `noteId: ${escapeHtml(existing.id)}` : "아직 공용 노트가 없습니다. 저장하면 생성됩니다."}
        </div>
      </div>

      <div class="field">
        <div class="muted">공용 노트(note) (지우려면 "" 저장)</div>
        <textarea id="defNoteTextarea" placeholder="예: 체온 측정 후 2시간 뒤 재측정">${escapeHtml(existing?.content ?? "")}</textarea>
      </div>
    `;

        const footer = `
      <button class="btn-ghost" onclick="closeModal()">닫기</button>
      <button id="btnSaveDefNote" class="btn-success">저장</button>
    `;

        openModal("TaskDefinition 공용 노트", body, footer);

        $("#btnSaveDefNote").addEventListener("click", async ()=>{
            try{
                const noteText = ($("#defNoteTextarea").value ?? "");
                const payload = { content: noteText };

                // 존재하면 PATCH, 없으면 POST
                if(existing?.id){
                    await API.patchDefinitionNote(state.patientId, state.date, existing.id, payload);
                    toast("공용 노트 수정 완료");
                }else{
                    await API.createDefinitionNote(state.patientId, state.date, {
                        taskDefinitionId: defId,
                        content: noteText
                    });
                    toast("공용 노트 생성 완료");
                }

                await reloadAll(false);
                closeModal();
            }catch(e){
                toast(e.message);
            }
        });
    }

    function renderTaskDetail(task){
        const def = state.defById.get(task.taskDefinitionId);

        // ✅ 공용 노트(정의 기준)
        const defNote = state.noteByDefId.get(task.taskDefinitionId) ?? null;
        const defNoteId = defNote?.id ?? null;
        const defNoteText = defNote?.content ?? "";

        const body = `
      <div class="help">
        저장 규칙: <b>null(미포함)=변경없음</b>, <b>""=값 비우기(미지정/삭제)</b><br/>
        • 정보(PATCH /tasks/{id}) / 상태(PATCH /tasks/{id}/status)
      </div>

      <div class="grid2">
        <div class="kv"><div class="k">Task ID</div><div class="v">${escapeHtml(task.id)}</div></div>
        <div class="kv"><div class="k">정의</div><div class="v">${escapeHtml(def?.name ?? task.taskDefinitionId)}</div></div>
        <div class="kv"><div class="k">날짜/시간</div><div class="v">${escapeHtml(task.taskDate)} / ${escapeHtml(task.taskHour)}시</div></div>
        <div class="kv"><div class="k">환자</div><div class="v">${escapeHtml(task.patientId)}</div></div>
        <div class="kv"><div class="k">생성자</div><div class="v">${escapeHtml(task.createdBy)}</div></div>
        <div class="kv"><div class="k">현재 담당자</div><div class="v">${escapeHtml(staffLabelById(task.assigneeId))}</div></div>
      </div>

      <div class="grid2">
        <div class="kv"><div class="k">Definition Note ID</div><div class="v">${escapeHtml(defNoteId ?? "-")}</div></div>
        <div class="kv"><div class="k">Definition Note</div><div class="v">${escapeHtml(defNoteText || "-")}</div></div>
      </div>

      <div class="two-col">
        <div class="field">
          <div class="muted">상태(status)</div>
          ${renderStatusSelect("detailStatusSelect", task.status)}
          <div class="muted" style="margin-top:6px">※ 상태 저장은 별도 버튼</div>
        </div>

        <div class="field">
          <div class="muted">담당자(assigneeId) (""=미지정)</div>
          ${renderStaffSelect("detailAssigneeSelect", task.assigneeId ?? "")}
          <div class="muted" style="margin-top:6px">현재: ${escapeHtml(task.assigneeId ?? "(null)")} / 표시: ${escapeHtml(staffLabelById(task.assigneeId))}</div>
        </div>
      </div>

      <div class="two-col">
        <div class="field">
          <div class="muted">업무 메모(taskNotes) (지우면 "" 전송)</div>
          <textarea id="detailNotes" placeholder="업무 메모를 입력">${escapeHtml(task.taskNotes ?? "")}</textarea>
        </div>
        <div class="field">
          <div class="muted">결과(result) (지우면 "" 전송)</div>
          <textarea id="detailResult" placeholder="결과를 입력">${escapeHtml(task.result ?? "")}</textarea>
        </div>
      </div>

      <div class="grid2">
        <div class="kv"><div class="k">createdAt</div><div class="v">${escapeHtml(task.createdAt)}</div></div>
        <div class="kv"><div class="k">updatedAt</div><div class="v">${escapeHtml(task.updatedAt)}</div></div>
        <div class="kv"><div class="k">startedAt</div><div class="v">${escapeHtml(task.startedAt ?? "-")}</div></div>
        <div class="kv"><div class="k">confirmRequestedAt</div><div class="v">${escapeHtml(task.confirmRequestedAt ?? "-")}</div></div>
        <div class="kv"><div class="k">completedAt</div><div class="v">${escapeHtml(task.completedAt ?? "-")}</div></div>
        <div class="kv"><div class="k">status</div><div class="v">${escapeHtml(task.status)}</div></div>
      </div>

      <div class="help" id="detailDiffHint">변경사항 없음</div>
    `;

        const footer = `
      <button class="btn-ghost" onclick="closeModal()">닫기</button>
      <button id="btnEditDefNote" class="btn-ghost">공용 노트 편집</button>
      <button id="btnSaveInfo" class="btn-success" disabled>정보 저장</button>
      <button id="btnSaveStatus" class="btn-success" disabled>상태 저장</button>
    `;

        openModal("업무 상세 (수정 가능)", body, footer);

        $("#btnEditDefNote").addEventListener("click", ()=>{
            openDefinitionNoteModal(task.taskDefinitionId);
        });

        const elStatus = $("#detailStatusSelect");
        const elAssignee = $("#detailAssigneeSelect");
        const elNotes = $("#detailNotes");
        const elResult = $("#detailResult");
        const hint = $("#detailDiffHint");

        const btnInfo = $("#btnSaveInfo");
        const btnStatus = $("#btnSaveStatus");

        const orig = {
            status: task.status ?? "",
            assigneeId: task.assigneeId ?? "",
            taskNotes: task.taskNotes ?? "",
            result: task.result ?? ""
        };

        function computeDiff(){
            const cur = {
                status: (elStatus.value ?? ""),
                assigneeId: (elAssignee.value ?? ""),        // "" 가능
                taskNotes: (elNotes.value ?? ""),            // "" 가능
                result: (elResult.value ?? "")               // "" 가능
            };

            const statusChanged = cur.status !== orig.status;
            const infoChanged =
                (cur.assigneeId !== orig.assigneeId) ||
                (cur.taskNotes !== orig.taskNotes) ||
                (cur.result !== orig.result);

            btnStatus.disabled = !statusChanged;
            btnInfo.disabled = !infoChanged;

            const parts = [];
            if(statusChanged) parts.push(`상태: ${orig.status} → ${cur.status}`);
            if(cur.assigneeId !== orig.assigneeId) parts.push(`담당자: ${staffLabelById(orig.assigneeId)} → ${staffLabelById(cur.assigneeId)}`);
            if(cur.taskNotes !== orig.taskNotes) parts.push(`메모: ${cur.taskNotes === "" ? "삭제" : "변경"}`);
            if(cur.result !== orig.result) parts.push(`결과: ${cur.result === "" ? "삭제" : "변경"}`);

            hint.textContent = parts.length ? `변경됨: ${parts.join(" / ")}` : "변경사항 없음";
            return {cur, statusChanged, infoChanged};
        }

        elStatus.addEventListener("change", computeDiff);
        elAssignee.addEventListener("change", computeDiff);
        elNotes.addEventListener("input", computeDiff);
        elResult.addEventListener("input", computeDiff);
        computeDiff();

        btnInfo.addEventListener("click", async ()=>{
            const {cur, infoChanged} = computeDiff();
            if(!infoChanged) return;

            try{
                btnInfo.disabled = true;
                btnInfo.textContent = "저장 중...";

                const payload = buildPatchPayloadWithEmptyAllowed(task, cur);
                if(Object.keys(payload).length === 0){
                    toast("변경사항 없음");
                    btnInfo.textContent = "정보 저장";
                    computeDiff();
                    return;
                }

                const updated = await API.patchTask(task.id, payload);

                toast("정보 저장 완료");
                await reloadAll(false);

                closeModal();
                renderTaskDetail(updated);
            }catch(e){
                toast(e.message);
            }finally{
                btnInfo.textContent = "정보 저장";
            }
        });

        btnStatus.addEventListener("click", async ()=>{
            const {cur, statusChanged} = computeDiff();
            if(!statusChanged) return;

            try{
                btnStatus.disabled = true;
                btnStatus.textContent = "저장 중...";

                const updated = await API.patchTaskStatus(task.id, cur.status);

                toast("상태 저장 완료");
                await reloadAll(false);

                closeModal();
                renderTaskDetail(updated);
            }catch(e){
                toast(e.message);
            }finally{
                btnStatus.textContent = "상태 저장";
            }
        });
    }

    function renderBlankRowPicker(hour){
        const existingDefIds = new Set(state.rows.filter(r=>r.type==="DEF").map(r=>r.defId));
        const available = state.defs
            .filter(d => !d.fixed)
            .filter(d => !existingDefIds.has(d.id))
            .sort((a,b)=> (a.name ?? "").localeCompare(b.name ?? ""));

        const options = available.map(d=>`<option value="${escapeHtml(d.id)}">${escapeHtml(d.name)} (OPTIONAL)</option>`).join("");

        const body = `
      <div class="help">
        공백 행에 추가할 항목을 선택하세요. (선택 후 해당 시간(${hour}시)에 Task 생성도 같이 진행)
      </div>
      <div class="grid2">
        <div>
          <div class="muted" style="margin:0 0 6px">추가할 TaskDefinition</div>
          <select id="pickDef">${options || `<option value="">추가 가능한 항목이 없습니다</option>`}</select>
        </div>
        <div>
          <div class="muted" style="margin:0 0 6px">업무 메모(선택)</div>
          <input id="pickNotes" type="text" placeholder="예: 측정 후 기록" />
        </div>
      </div>
      <div class="muted">선택한 항목은 표에 새 행으로 추가됩니다.</div>
    `;

        const footer = `
      <button class="btn-ghost" onclick="closeModal()">취소</button>
      <button id="btnAddDefAndCreate" ${available.length ? "" : "disabled"}>추가 + 생성</button>
    `;

        openModal("공백 행: 항목 추가", body, footer);

        $("#btnAddDefAndCreate")?.addEventListener("click", async ()=>{
            const defId = $("#pickDef").value;
            if(!defId){ toast("선택 가능한 항목이 없습니다."); return; }
            const notes = $("#pickNotes").value || null;
            try{
                await createTask(defId, hour, notes);
                await reloadAll(false);
                closeModal();
                toast("추가 및 생성 완료");
            }catch(e){
                toast(e.message);
            }
        });
    }

    function renderCreateTaskModal(defId, hour){
        const def = state.defById.get(defId);

        const body = `
      <div class="help">
        <b>${escapeHtml(def?.name ?? defId)}</b> · ${escapeHtml(state.date)} / ${hour}시 Task를 생성합니다.
      </div>

      <div class="grid2">
        <div>
          <div class="muted" style="margin:0 0 6px">업무 메모(taskNotes)</div>
          <input id="createNotes" type="text" placeholder="예: 체온 측정 후 기록" />
        </div>
        <div>
          <div class="muted" style="margin:0 0 6px">담당자 선택(선택)</div>
          ${renderStaffSelect("createAssigneeSelect", "")}
        </div>
      </div>

      <div class="muted">※ 생성되면 기본 상태는 PENDING 입니다.</div>
    `;

        const footer = `
      <button class="btn-ghost" onclick="closeModal()">취소</button>
      <button id="btnCreateTask">생성</button>
    `;

        openModal("업무 생성", body, footer);

        $("#btnCreateTask").addEventListener("click", async ()=>{
            const notes = $("#createNotes").value || null;
            const assigneeId = $("#createAssigneeSelect").value.trim(); // "" 가능 (미지정 저장)
            try{
                await createTask(defId, hour, notes, assigneeId);
                await reloadAll(false);
                closeModal();
                toast("업무가 생성되었습니다.");
            }catch(e){
                toast(e.message);
            }
        });
    }

    /***********************
     * CORE ACTIONS
     ***********************/
    async function loadInitial(patientId, date){
        state.patientId = patientId;
        state.date = date;

        try{
            state.staffs = await API.getStaffs();
            state.staffById = new Map((state.staffs ?? []).map(s => [s.id, s]));
        }catch(e){
            state.staffs = [];
            state.staffById = new Map();
            toast(e.message);
        }

        state.patient = await API.getPatient(patientId);

        state.defs = await API.getTaskDefinitions();
        state.defById = new Map(state.defs.map(d => [d.id, d]));
        state.fixedDefs = state.defs.filter(d => !!d.fixed);
        state.notFixedDefs = state.defs.filter(d => !d.fixed);

        state.tasks = await API.getPatientDayTasks(patientId, date);

        // ✅ NEW: definition-notes 로딩
        try{
            state.definitionNotes = await API.getDefinitionNotes(patientId, date);
        }catch(e){
            state.definitionNotes = [];
            toast(e.message);
        }
        buildNoteMap();

        buildTaskMap();
        buildRows();
        renderPatient();
        renderTable();
    }

    async function reloadAll(showToast=true){
        if(!state.patientId || !state.date) return;

        try{
            if(showToast) toast("새로고침 중...");

            state.patient = await API.getPatient(state.patientId);
            state.defs = await API.getTaskDefinitions();
            state.defById = new Map(state.defs.map(d => [d.id, d]));
            state.fixedDefs = state.defs.filter(d => !!d.fixed);
            state.notFixedDefs = state.defs.filter(d => !d.fixed);
            state.tasks = await API.getPatientDayTasks(state.patientId, state.date);

            // ✅ NEW: definition-notes 재로딩
            try{
                state.definitionNotes = await API.getDefinitionNotes(state.patientId, state.date);
            }catch(e){
                state.definitionNotes = [];
                toast(e.message);
            }
            buildNoteMap();

            buildTaskMap();
            buildRows();
            renderPatient();
            renderTable();

            if(showToast) toast("새로고침 완료");
        }catch(e){
            toast(e.message);
        }
    }

    async function createTask(defId, hour, notes=null, assigneeId=""){
        const payload = {
            patientId: state.patientId,
            taskDefinitionId: defId,
            taskDate: state.date,
            taskHour: hour,
            taskNotes: notes,
            assigneeId: assigneeId
        };
        return await API.createTask(payload);
    }

    /***********************
     * TABLE CLICK HANDLER
     ***********************/
    $("#chartTable").addEventListener("click", (e)=>{
        // NOTE cell click
        const noteTd = e.target.closest("td.note-cell[data-cell-kind='NOTE']");
        if(noteTd){
            const defId = noteTd.dataset.defId;
            if(defId) openDefinitionNoteModal(defId);
            return;
        }

        // TASK cell click
        const td = e.target.closest("td.cell[data-cell-kind='TASK']");
        if(!td) return;

        const rowType = td.dataset.rowType;
        const defId = td.dataset.defId;
        const hour = Number(td.dataset.hour);

        if(rowType === "DEF"){
            const t = state.taskMap.get(`${defId}|${hour}`) ?? null;
            if(t) renderTaskDetail(t);
            else renderCreateTaskModal(defId, hour);
        }else{
            renderBlankRowPicker(hour);
        }
    });

    /***********************
     * BOOTSTRAP
     ***********************/
    function setInputsFromState(){
        $("#jwtInput").value = state.jwtToken ?? "";
        $("#patientIdInput").value = state.patientId ?? "";
        $("#dateInput").value = state.date ?? "";
    }

    async function boot(){
        const { pid, date } = getPathParamsFromUrl();

        const defaultPid = "e2da4625-7158-496f-9f84-9d26b7086ef2";
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,"0");
        const dd = String(today.getDate()).padStart(2,"0");
        const defaultDate = `${yyyy}-${mm}-${dd}`;

        state.jwtToken = localStorage.getItem("jwtToken") || "";
        state.patientId = pid || defaultPid;
        state.date = date || defaultDate;

        setInputsFromState();

        try{
            await loadInitial(state.patientId, state.date);
            toast("불러오기 완료");
        }catch(e){
            toast(e.message);
        }
    }

    $("#btnLoad").addEventListener("click", async ()=>{
        readJwtFromInputAndPersist();

        const pid = $("#patientIdInput").value.trim();
        const date = $("#dateInput").value;

        if(!pid){ toast("patientId를 입력해줘"); return; }
        if(!date){ toast("date를 선택해줘"); return; }

        const newUrl = `/patients/${pid}/management-charts/${date}`;
        history.pushState({}, "", newUrl);

        try{
            await loadInitial(pid, date);
            toast("불러오기 완료");
        }catch(e){
            toast(e.message);
        }
    });

    $("#btnReload").addEventListener("click", ()=>{
        readJwtFromInputAndPersist();
        reloadAll(true);
    });

    window.closeModal = closeModal;
    boot();
</script>
</body>
</html>
